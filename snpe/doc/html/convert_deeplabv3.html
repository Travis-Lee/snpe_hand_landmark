<!--%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  Copyright (c) 2016-2018 Qualcomm Technologies, Inc.
  All Rights Reserved.
  Confidential and Proprietary - Qualcomm Technologies, Inc.
 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
-->
<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"></meta>
<meta http-equiv="X-UA-Compatible" content="IE=9"></meta>
<title>Snapdragon Neural Processing Engine SDK: Using DeepLabv3</title>
<link href="tabs.css" rel="stylesheet" type="text/css"></link>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="autoEnterCurrentDate.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="is.css" rel="stylesheet" type="text/css" ></link>
<link href="custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Snapdragon Neural Processing Engine SDK
   <span id="projectnumber"></span></div>
   <div id="projectbrief">Reference Guide</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('convert_deeplabv3.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Using DeepLabv3 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="el" href="convert_deeplabv3.html#deeplabv3_conversion_tf">Tensorflow DeepLabv3 model</a> <br />
<a class="el" href="convert_deeplabv3.html#deeplabv3_preprocessing">Preprocessing Input Images</a> <br />
<a class="el" href="convert_deeplabv3.html#deeplabv3_running">Running the model in SNPE</a> <br />
<a class="el" href="convert_deeplabv3.html#deeplabv3_postprocessing">Postprocessing Output Segmentation Maps</a> <br />
 </p>
<h1><a class="anchor" id="deeplabv3_conversion_tf"></a>
Tensorflow DeepLabv3 model</h1>
<p>A specific version of the Tensorflow DeepLabv3 model has been tested: <b>deeplabv3_mnv2_pascal_train_aug_2018_01_29.tar</b>. This version of DeepLabv3 uses MobileNet-v2 as the backbone and has been pretrained on the Pascal VOC 2012 dataset.</p>
<p>Download the model. </p><pre class="fragment">wget http://download.tensorflow.org/models/deeplabv3_mnv2_pascal_train_aug_2018_01_29.tar.gz</pre><p>After downloading the model extract the contents to a directory.</p>
<pre class="fragment">tar xzvf deeplabv3_mnv2_pascal_train_aug_2018_01_29.tar.gz</pre><p>Convert the model using the <a class="el" href="tools.html#tools_snpe-tensorflow-to-dlc">snpe-tensorflow-to-dlc</a> converter.</p>
<pre class="fragment">snpe-tensorflow-to-dlc --input_network deeplabv3_mnv2_pascal_train_aug/frozen_inference_graph.pb --input_dim sub_7 1,513,513,3 --out_node ArgMax --output_path deeplabv3.dlc --allow_unconsumed_nodes</pre><p>The output layers for the model is: </p><ul>
<li>
ArgMax </li>
</ul>
<p>The output buffer names is: </p><ul>
<li>
(Segmentation Map) ArgMax:0.raw </li>
</ul>
<h1><a class="anchor" id="deeplabv3_preprocessing"></a>
Preprocessing Input Images</h1>
<p>SNPE does not support the preprocessing done within the DeepLabv3 model. Preprocessing must be done offline before the images are run. In the preprocessing phase, images must be resized to 513x513x3 and the pixels must be normalized to be between -1 to 1.</p>
<p>The following steps need to be performed on all input images in this exact order: </p><ol>
<li>
Calculate the resize ratio and target size of the image using the following: <pre class="fragment">resize_ratio = 513.0 / max(width, height)
target_size = (int(resize_ratio * width), int(resize_ratio * height))</pre> </li>
<li>
Convert the image to the target_size, using an Anti-alias resampling filter. This will make the longer dimension of the image to be 513 and the other dimension will be smaller than 513. </li>
<li>
Pad the smaller dimension with the mean value of 128 to produce an image of 513x513x3. </li>
<li>
Convert the image to type float32. </li>
<li>
Multiply the image elementwise with 0.00784313771874. </li>
<li>
Elementwise subtract 1.0 from the image. </li>
</ol>
<h1><a class="anchor" id="deeplabv3_running"></a>
Running the model in SNPE</h1>
<p>The following are limitations and suggestions for running DLC model in SNPE: </p><ul>
<li>
Some operations in the model are supported on CPU runtime processor only.<br />
 To run the model using different runtime processor, such as GPU or DSP, CPU fallback mode must be enabled in Runtime List (see SNPEBuilder::setRuntimeProcessorOrder() description in <a href="group__c__plus__plus__apis.html">C++ API</a>).<br />
 If using <a class="el" href="tools.html#tools_snpe-net-run">snpe-net-run</a> tool, use <code>&ndash;runtime_order</code> option  </li>
</ul>
<h1><a class="anchor" id="deeplabv3_postprocessing"></a>
Postprocessing Output Segmentation Maps</h1>
<p>Running DeepLabv3 with SNPE will produce an output segmentation map of size 513x513x1 where every element is an integer that represents a class (e.g. 0=background, etc.).<br />
However the output of SNPE still has the padding applied in the preprocessing step. This padding must be cropped out and the image should be resized to the orginal size.</p>
<p>The following steps should be taken in order to get the same dimensions as the original image: </p><ol>
<li>
Crop off the padding that was applied to the shorter dimension in the pre-processing step. The ratio of the dimensions of the segmentation map should now be the same as the original image. </li>
<li>
Resize the segmentation map to the height and width of the original image. </li>
</ol>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!--%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  Copyright (c) 2016-2018 Qualcomm Technologies, Inc.
  All Rights Reserved.
  Confidential and Proprietary - Qualcomm Technologies, Inc.
 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 -->
<!-- start footer part -->
<div id="nav-path" class="navpath" font-size:small;><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">
      <p align="right">
        80-NL315-14 A <br>
        MAY CONTAIN U.S. AND INTERNATIONAL EXPORT CONTROLLED INFORMATION
        <!--If the Controlled Distribution statement is to be included, uncomment below:-->
        <!--<b>Controlled Distribution - DO NOT COPY</b>-->
        <img class="footer" width:5%; alt="QTI Logo" src="images/QTI_Logo.png" />
      </p>
    </li>
  </ul>
</div>
</body>
</html>
