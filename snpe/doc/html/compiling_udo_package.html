<!--%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  Copyright (c) 2016-2018 Qualcomm Technologies, Inc.
  All Rights Reserved.
  Confidential and Proprietary - Qualcomm Technologies, Inc.
 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
-->
<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"></meta>
<meta http-equiv="X-UA-Compatible" content="IE=9"></meta>
<title>Snapdragon Neural Processing Engine SDK: Compiling a UDO package</title>
<link href="tabs.css" rel="stylesheet" type="text/css"></link>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="autoEnterCurrentDate.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="is.css" rel="stylesheet" type="text/css" ></link>
<link href="custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Snapdragon Neural Processing Engine SDK
   <span id="projectnumber"></span></div>
   <div id="projectbrief">Reference Guide</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('compiling_udo_package.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Compiling a UDO package </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="compiling_udo_package_intro"></a>
Introduction</h1>
<p>This section provides information about compiling UDO packages for all supported runtimes in SNPE.</p>
<p>As explained in <a class="el" href="udo_overview.html">Overview of UDO</a>, a set of registration and implementation libraries is collectively referred to as a UDO package. The user has complete control over building these libraries for their desired runtimes using compatible tool-chains. Alternatively, SNPE SDK offers tools and utilities to create and compile a UDO easily. For more information about the tool used to create a UDO package refer to <a class="el" href="creating_udo_package.html">Creating a UDO package</a>. This section explains UDO package compilation based on the directory structure provided by the package generator.</p>
<h1><a class="anchor" id="implementing_udo"></a>
Implementing a User-defined operation</h1>
<p>Fundamentally, a UDO is required to be developed using the set of APIs defined in header files located at $SNPE_ROOT/share/SnpeUdo/include. Each runtime may impose additional requirements and provide options for customizing the implementation to suit the runtime. Details of the UDO APIs can be found in the API documentation at <a href="group__c__plus__plus__apis.html">C++ API</a>.<br />
 This section assumes that a UDO package was generated using the UDO package generator tool described in <a class="el" href="creating_udo_package.html">Creating a UDO package</a> which produces a partial implementation skeleton based on the UDO specification configured by the user.</p>
<h1><a class="anchor" id="compiling_package_targets"></a>
Make Targets for Package Compilation</h1>
<p>The UDO package generator tool creates a makefile to compile the package for a specific runtime and target platform combination. The makefile is intended to provide a simple interface to compile for platforms that use make natively or require ndk-build. Using the provided makefile also allows for per library compilation for various targets.</p>
<p>The general form of each make target is &lt;runtime&gt;_&lt;platform&gt;. Targets that are only of the form &lt;runtime&gt; include all possible targets. For instance, running </p><pre class="fragment">make cpu
</pre><p> will compile the CPU for both x86 and Android platforms. Additionally, for applicable platforms the PLATFORM make variable can be used to select a specific platform ABI similar to APP_ABI in ndk-build. By default PLATFORM is set to both arm64-v8a and armeabi-v7a. A comprehensive table of available make targets is presented <a class="el" href="compiling_udo_package.html#udo_make_targets">below</a> .</p>
<p><b>Note:</b> Use of the makefile is optional and not required to generate libraries.</p>
<p><b>Note:</b> For all following examples, the displayed artifacts are for arm64-v8a target.</p>
<h1><a class="anchor" id="implementing_udo_for_cpu"></a>
Implementing a UDO for CPU</h1>
<p>A CPU UDO implementation library based on core UDO APIs is required to run a UDO package on CPU runtime.<br />
 The UDO package generator tool will create a skeleton containing blank constructs in the required format, but the core logic of creating and execution of the operation needs to be filled in by the user. This can be done by completing the implementation of <code>createOp()</code> and <code>snpeUdoExecute()</code> functions in the &lt;UDO-type&gt;ImplLibCpu.cpp file generated by the UDO package generator tool.</p>
<p><b>Note:</b> One important notion to take into account is that the SNPE provides tensor data corresponding to all the inputs and outputs of a UDO not directly inside <code>tensorData</code> defined in <code><a class="el" href="group__c__plus__plus__apis.html#structSnpeUdo__TensorParam__t" title="A struct which defines a tensor parameter : name, data type, layout, quantization, more. Also holds a pointer to the tensor data. ">SnpeUdo_TensorParam_t</a></code> but as an opaque pointer. The UDO implementation is expected to get a handle to the raw tensor pointers using the methods in the per-op factory infrastructure object issued by SNPE at the time of creating the UDO op factory. Refer to <code><a class="el" href="group__c__plus__plus__apis.html#structSnpeUdo__CpuInfrastructure__t" title="This struct provides the infrastructure needed by a developer of CPU UDO Implementation library...">SnpeUdo_CpuInfrastructure_t</a></code> for more details on the data structure. The CPU runtime operates only with floating point activation tensors. Therefore CPU UDO implementations should be implemented to receive and produce only floating point tensors, and set the field data_type in the config file to FLOAT_32. All other data types will be ignored. Refer to <a class="el" href="udo_operator_definition.html">Defining a UDO</a> for more details.</p>
<p>Compiling and running the UDO package on host is required for SNPE model quantization tool, <code>snpe-dlc-quantize</code>. It is necessary to quantize a model using snpe-dlc-quantize, to run a UDO layer that has at least one non-float input on the DSP.</p>
<h1><a class="anchor" id="compiling_udo_for_CPU_host"></a>
Compiling a UDO for CPU on host</h1>
<p>Steps to compile the CPU UDO implementation library on host x86 platform are as below:</p>
<ol>
<li>
<p class="startli">Set the environment variable <code>$SNPE_UDO_ROOT</code>.<br />
 </p><pre class="fragment">export SNPE_UDO_ROOT=&lt;absolute_path_to_SnpeUdo_headers_directory&gt;</pre><p class="endli"></p>
</li>
<li>
<p class="startli">Run the make instruction below to compile the UDO package:</p>
<pre class="fragment">make cpu_x86</pre><p class="endli"></p>
</li>
</ol>
<p>The expected artifacts after compiling for Host CPU are</p><ul>
<li>The UDO CPU implementation library: &lt;UDO-Package&gt;/libs/x86-64_linux_clang/libUdo&lt;UDO-Package&gt;ImplCpu.so</li>
<li>The UDO package registration library: &lt;UDO-Package&gt;/libs/x86-64_linux_clang/libUdo&lt;UDO-Package&gt;Reg.so <br />
</li>
</ul>
<p><b>Note:</b> The command must be run from the package root.</p>
<h1><a class="anchor" id="compiling_udo_for_CPU_on_device"></a>
Compiling a UDO for CPU on device</h1>
<p>Steps to compile the CPU UDO implementation library on Android platform are as below:</p>
<ol>
<li>
<p class="startli">Set the environment variable <code>$SNPE_UDO_ROOT</code>.<br />
 </p><pre class="fragment">export SNPE_UDO_ROOT=&lt;absolute_path_to_SnpeUdo_headers_directory&gt;</pre><p class="endli"></p>
</li>
<li>
<p class="startli"><code>$NDK_BUILD</code> must be set for the Android NDK build toolchain.</p>
<pre class="fragment">export NDK_BUILD=&lt;absolute_path_to_android_ndk_directory&gt;</pre><p class="endli"></p>
</li>
<li>
<p class="startli">Run the make instruction below to compile the UDO package:</p>
<pre class="fragment">make cpu_android</pre><p> The shared C++ standard library is required for the NDK build to run. Make sure libc++_shared.so is present on the device at <code>LD_LIBRARY_PATH</code>. </p>
</li>
</ol>
<p>The expected artifacts after compiling for Android CPU are</p><ul>
<li>The UDO CPU implementation library: &lt;UDO-Package&gt;/libs/arm64-v8a/libUdo&lt;UDO-Package&gt;ImplCpu.so</li>
<li>The UDO package registration library: &lt;UDO-Package&gt;/libs/arm64-v8a/libUdo&lt;UDO-Package&gt;Reg.so</li>
<li>A copy of shared standard C++ library: &lt;UDO-Package&gt;/libs/arm64-v8a/libc++_shared.so</li>
</ul>
<h1><a class="anchor" id="implementing_udo_for_gpu"></a>
Implementing a UDO for GPU</h1>
<p>Similar to the CPU runtime, a GPU UDO implementation library based on core UDO APIs is required to run a UDO package on GPU runtime.<br />
 The UDO package generator tool will create a skeleton containing blank constructs in the required format, but the core logic of creating and execution of the operation needs to be filled in by the user. This can be done by completing the implementation of <code>createOp()</code> function and adding the GPU kernel implementations in the &lt;UDO-type&gt;ImplLibCpu.cpp file generated by the UDO package generator tool.<br />
</p>
<p>SNPE GPU UDO supports 16-bit floating point activations in the network. Users should expect input/output OpenCL buffer memory from SNPE GPU UDO to be in 16-bit floating point (or OpenCL half) data format as the storage type. For increased accuracy, users may choose to implement internal math operations of the kernel using 32-bit floating point data, and converting to half precision when reading input buffers or writing output buffers from the UDO kernel.</p>
<p>SNPE GPU allows users the option to cache OpenCL program associated with multiple GPU UDO instances of similar type. It provides APIs to retrieve and store OpenCL program through <code><a class="el" href="group__c__plus__plus__apis.html#structSnpeUdo__GpuInfrastructure__t" title="Global Infrastructure Definition for GPU UDO Implementations. ">SnpeUdo_GpuInfrastructure_t</a></code>. Caching improves JIT compilation time of OpenCL program during subsequent invocations in the network.</p>
<p><b>Note:</b> SNPE provides tensor data corresponding to all the inputs and outputs of a UDO not directly inside <code>tensorData</code> but as an opaque pointer. The UDO implementation is expected to convert it to <code><a class="el" href="group__c__plus__plus__apis.html#structSnpeUdo__GpuTensorData__t" title="Opaque tensorData definition for operation inputs and outputs. ">SnpeUdo_GpuTensorData_t</a></code> and which holds OpenCL memory pointer for tensor. Refer to <code><a class="el" href="group__c__plus__plus__apis.html#structSnpeUdo__GpuTensorData__t" title="Opaque tensorData definition for operation inputs and outputs. ">SnpeUdo_GpuTensorData_t</a></code> for more details. Per-op factory infrastructure object issued by SNPE at the time of creating the UDO op factory will provide users OpenCL context and OpenCL commandqueue. Refer to <code><a class="el" href="group__c__plus__plus__apis.html#structSnpeUdo__GpuOpFactoryInfrastructure__t" title="Per OpFactory Infrastructure Definition for GPU UDO Implementations. ">SnpeUdo_GpuOpFactoryInfrastructure_t</a></code> for more details on the data structure.</p>
<h1><a class="anchor" id="compiling_udo_for_GPU_on_device"></a>
Compiling a UDO for GPU on device</h1>
<p>Steps to compile the GPU UDO implementation library on Android platform are as below:</p>
<ol>
<li>
<p class="startli">Set the environment variable <code>$SNPE_UDO_ROOT</code>.<br />
 </p><pre class="fragment">export SNPE_UDO_ROOT=&lt;absolute_path_to_SnpeUdo_headers_directory&gt;</pre><p class="endli"></p>
</li>
<li>
<p class="startli"><code>$NDK_BUILD</code> must be set for the Andorid NDK build toolchain.</p>
<pre class="fragment">export NDK_BUILD=&lt;absolute_path_to_android_ndk_directory&gt;</pre><p class="endli"></p>
</li>
<li>
<p class="startli"><code>$CL_LIBRARY_PATH</code> must be set for the libOpenCL.so library location.</p>
<pre class="fragment">export CL_LIBRARY_PATH=&lt;absolute_path_to_OpenCL_library&gt;</pre><p> The OpenCL shared library is not distributed as part of SNPE SDK.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">Run the make instruction below to compile the UDO package:</p>
<pre class="fragment">make gpu_android</pre> </li>
</ol>
<p><b>Note:</b> The shared OpenCL library is target specific. It should be discoverable in <code>CL_LIBRARY_PATH</code>.</p>
<p>The expected artifacts after compiling for Android GPU are</p><ul>
<li>The UDO GPU implementation library: &lt;UDO-Package&gt;/libs/arm64-v8a/libUdo&lt;UDO-Package&gt;ImplGpu.so</li>
<li>The UDO package registration library: &lt;UDO-Package&gt;/libs/arm64-v8a/libUdo&lt;UDO-Package&gt;Reg.so</li>
<li>A copy of shared standard C++ library: &lt;UDO-Package&gt;/libs/arm64-v8a/libc++_shared.so</li>
<li>A copy of shared OpenCL library: &lt;UDO-Package&gt;/libs/arm64-v8a/libOpenCL.so</li>
</ul>
<h1><a class="anchor" id="implementing_udo_for_dsp"></a>
Implementing a UDO for DSP</h1>
<p>SNPE utilizes Hexagon-NN to run UDO layers on DSP. Therefore, a DSP implementation library based on core UDO APIs for Hexagon-NN is required to run a UDO package on DSP runtime.<br />
 The UDO package generator tool will create the template file &lt;UDO-type&gt;ImplLibDsp.c and &lt;UDO-type&gt;ImplLibDsp.h and the user will need to implement the execution logic in the <code><a class="el" href="group__c__plus__plus__apis.html#gabfc1c092667f22b0095837425d16438e" title="Operation execution function. ">SnpeUdo_executeOp()</a></code> function in the .c file as well as the <code>&lt;UDO-type&gt;OpInfo</code> struct in the header file for storing operation execute information.<br />
 SNPE UDO provides the support for multi-threading of the operation using worker threads, Hexagon Vector Extensions (HVX) code and VTCM support.<br />
 The DSP runtime only propagates unsigned 8-bit activation tensors between the network layers. But it has the ability to de-quantize data to floating point if required. Therefore users developing DSP kernels can expect either UINT_8 or FLOAT_32 activation tensors in and out of the operation, and thus can set the field data_type in the config file to one of these two settings. Refer to <a class="el" href="udo_operator_definition.html">Defining a UDO</a> for more details.</p>
<p><b>Note:</b> Only C files are supported for UDO on DSP runtime.</p>
<h1><a class="anchor" id="compiling_udo_for_DSP_on_device"></a>
Compiling a UDO for DSP on device</h1>
<p>This SNPE release supports building UDO DSP implementation libraries using Hexagon-SDK 3.5.1/3.5.2.</p>
<ol>
<li>
<p class="startli">Set the environment variables <code>$SNPE_UDO_ROOT</code> </p><pre class="fragment">export SNPE_UDO_ROOT=&lt;absolute_path_to_SnpeUdo_headers_directory&gt;</pre><p class="endli"></p>
</li>
<li>
<p class="startli">Hexagon-SDK needs to be installed and set up. For details, follow the setup instructions on <code>$HEXAGON_SDK_ROOT/docs/readme.html</code> page, where <code>HEXAGON_SDK_ROOT</code> is the location of the Hexagon-SDK installation. Make sure <code>$HEXAGON_SDK_ROOT</code> is set to use the Hexagon-SDK build toolchain. Also set <code>$HEXAGON_TOOLS_ROOT</code> and <code>SDK_SETUP_ENV</code> </p><pre class="fragment">export HEXAGON_SDK_ROOT=&lt;path to hexagon sdk installation&gt;
export HEXAGON_TOOLS_ROOT=$HEXAGON_SDK_ROOT/tools/HEXAGON_Tools/8.3.07
export SDK_SETUP_ENV=Done</pre><p class="endli"></p>
</li>
<li>
<p class="startli">Run the make instruction below to compile the UDO DSP implementation library:</p>
<pre class="fragment">make dsp</pre><p class="endli"></p>
</li>
</ol>
<p>The expected artifacts after compiling for DSP are</p><ul>
<li>The UDO DSP implementation library: &lt;UDO-Package&gt;/libs/dsp/libUdo&lt;UDO-Package&gt;ImplDsp.so</li>
<li>The UDO package registration library: &lt;UDO-Package&gt;/libs/arm64-v8a/libUdo&lt;UDO-Package&gt;Reg.so</li>
</ul>
<p>Note: The command must be run from the package root.</p>
<h1><a class="anchor" id="udo_make_targets"></a>
Table of Make Targets</h1>
<table class="doxtable">
<tr>
<th align="center">Make Target </th><th align="center">Runtime </th><th align="center">Platform </th><th align="center">Misc.  </th></tr>
<tr>
<td align="center">all </td><td align="center">CPU, GPU, DSP </td><td align="center">x86, Specified by PLATFORM (default arm64-v8a and armeabi-v7a) </td><td align="center"></td></tr>
<tr>
<td align="center">all_x86 </td><td align="center">CPU </td><td align="center">x86 </td><td align="center"></td></tr>
<tr>
<td align="center">all_android </td><td align="center">CPU, GPU, DSP </td><td align="center">Specified by PLATFORM (default arm64-v8a and armeabi-v7a) </td><td align="center"></td></tr>
<tr>
<td align="center">reg </td><td align="center">- </td><td align="center">x86, Specified by PLATFORM (default arm64-v8a and armeabi-v7a) </td><td align="center"></td></tr>
<tr>
<td align="center">reg_x86 </td><td align="center">- </td><td align="center">x86 </td><td align="center"></td></tr>
<tr>
<td align="center">reg_android </td><td align="center">- </td><td align="center">Specified by PLATFORM (default arm64-v8a and armeabi-v7a) </td><td align="center"></td></tr>
<tr>
<td align="center">cpu </td><td align="center">CPU </td><td align="center">x86, Specified by PLATFORM (default arm64-v8a and armeabi-v7a) </td><td align="center"></td></tr>
<tr>
<td align="center">cpu_x86 </td><td align="center">CPU </td><td align="center">x86 </td><td align="center">Same as all_x86 </td></tr>
<tr>
<td align="center">cpu_android </td><td align="center">CPU </td><td align="center">Specified by PLATFORM (default arm64-v8a and armeabi-v7a) </td><td align="center"></td></tr>
<tr>
<td align="center">gpu </td><td align="center">GPU </td><td align="center">Specified by PLATFORM (default arm64-v8a and armeabi-v7a) </td><td align="center"></td></tr>
<tr>
<td align="center">gpu_android </td><td align="center">GPU </td><td align="center">Specified by PLATFORM (default arm64-v8a and armeabi-v7a) </td><td align="center">Same as gpu </td></tr>
<tr>
<td align="center">dsp </td><td align="center">DSP </td><td align="center">- </td><td align="center"></td></tr>
<tr>
<td align="center">dsp_android </td><td align="center">DSP </td><td align="center">- </td><td align="center">Same as dsp </td></tr>
</table>
<p><b>Note:</b> By default compiling for a runtime additionally compiles the corresponding registration library </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!--%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  Copyright (c) 2016-2018 Qualcomm Technologies, Inc.
  All Rights Reserved.
  Confidential and Proprietary - Qualcomm Technologies, Inc.
 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 -->
<!-- start footer part -->
<div id="nav-path" class="navpath" font-size:small;><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">
      <p align="right">
        80-NL315-14 A <br>
        MAY CONTAIN U.S. AND INTERNATIONAL EXPORT CONTROLLED INFORMATION
        <!--If the Controlled Distribution statement is to be included, uncomment below:-->
        <!--<b>Controlled Distribution - DO NOT COPY</b>-->
        <img class="footer" width:5%; alt="QTI Logo" src="images/QTI_Logo.png" />
      </p>
    </li>
  </ul>
</div>
</body>
</html>
