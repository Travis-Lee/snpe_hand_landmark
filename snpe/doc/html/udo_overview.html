<!--%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  Copyright (c) 2016-2018 Qualcomm Technologies, Inc.
  All Rights Reserved.
  Confidential and Proprietary - Qualcomm Technologies, Inc.
 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
-->
<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"></meta>
<meta http-equiv="X-UA-Compatible" content="IE=9"></meta>
<title>Snapdragon Neural Processing Engine SDK: Overview of UDO</title>
<link href="tabs.css" rel="stylesheet" type="text/css"></link>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="autoEnterCurrentDate.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="is.css" rel="stylesheet" type="text/css" ></link>
<link href="custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Snapdragon Neural Processing Engine SDK
   <span id="projectnumber"></span></div>
   <div id="projectbrief">Reference Guide</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('udo_overview.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Overview of UDO </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="udo_introduction"></a>
Introduction</h1>
<p>SNPE provides the ability for users to plug in custom neural network operations that may not be inherently supported by the runtime engine in the form of User-defined Operations (hereafter referred to as UDO). These could be operations defined in popular training frameworks such as Tensorflow or custom operations that are built based as framework extensions but not available in the SNPE SDK. They can be natively executed on any of the supported hardware accelerators for which they are implemented. SNPE provides the infrastructure to execute these operations in a seamless fashion with little to no overhead compared to executing internally supported operations.</p>
<h1><a class="anchor" id="udo_vs_udl"></a>
Comparing UDO with UDL</h1>
<p>SNPE has existing support for users to include custom operations to be executed on CPU at runtime with User-defined layers, abbreviated as UDL (see <a class="el" href="udl_tutorial.html">User-Defined Layers (UDL) Tutorial</a>). User-defined operations can be considered an enhancement over UDLs for the following reasons:<br />
</p>
<p>(i) <b>Integration with improved visibility</b><br />
 UDLs are implemented in ways that make attributes of the layers completely opaque to SNPE. This requires them to be handled in total isolation from the rest of the layers in the network and in their own subnets. On the other hand, UDOs are designed to be able to express their attributes with SNPE components while preserving opacity with the actual implementation kernels. This allows SNPE to understand their properties such as input and output tensor dimensions and connect them with their neighboring operations in the network, resulting in optimal network partitions.</p>
<p>(ii) <b>Extended targets for execution</b><br />
 The UDL mechanism allows users to register a callback to switch the execution context during runtime from SNPE into their proprietary method that implements the operation of their custom layer on the CPU. SNPE partitions the network model into subnets that separate native layers from user-defined ones. In cases when other subnets are scheduled to execute on other hardware accelerators such as the DSP or the GPU, this mechanism induces significant overhead in switching the execution context over to the ARM CPU, which is the only target on which a UDL can run. This mechanism is illustrated in the figure below with the example of a network scheduled to run on the GPU:</p>
<p><a class="anchor" id="fig_udl_mechanism"></a><p> <div style= text-align:left;><img src="images/UdlMechanism.png" alt="UDL" width="40%" height="40%"><br/><br/><b></b></div><br/> </p>
<p>The UDO mechanism improves on this approach by allowing users to integrate their custom operations on any supported hardware accelerator by compiling for specific targets such as the GPU or DSP in addition to ARM CPU. The UDO mechanism allows SNPE to construct subnets that may encompass UDOs without having to switch to the CPU by default. It reduces context switching overheads as well as allows users to take advantage of executing their operations on desired accelerators and get superior performance. This mechanism is illustrated in the figure below with the example of a network scheduled to run on the GPU and the UDO compiled for GPU as well:</p>
<p><a class="anchor" id="fig_udo_mechanism"></a><p> <div style= text-align:left;><img src="images/UdoMechanism.png" alt="UDO" width="40%" height="40%"><br/><br/><b></b></div><br/> </p>
<p>(iii) <b>Additional Training Frameworks supported</b><br />
 UDL is supported only with Caffe-based networks. UDOs are supported on Tensorflow and ONNX models with support for Caffe to be added soon.</p>
<h1><a class="anchor" id="udo_package"></a>
Anatomy of a UDO package</h1>
<p>SNPE allows users to provide UDO implementations in the form of dynamic libraries that can be queried, loaded and exercised to execute inference using kernels defined within them. SNPE promotes the notion of a 'UDO package' with which a user can easily express the association between the different components of a UDO. This notion is central to all the tools that enable users to create UDO packages to be used in network inference. However, it is to be noted that SNPE still directly interfaces with the various UDO libraries at runtime and not with the UDO package construct. Thus users are free to just build standalone libraries without being strictly bound to this notion of a package.<br />
 The figure below illustrates the concept of a UDO package:</p>
<p><a class="anchor" id="fig_udo_package"></a><p> <div style= text-align:left;><img src="images/UdoPackage.png" alt="UDO" width="40%" height="40%"><br/><br/><b></b></div><br/> </p>
<p>As seen from the picture a UDO package consists of a registration component and an implementation component. They are usually expressed separately with one registration library and a set of implementation libraries, one for each hardware accelerator for which an implementation kernel is available. Users can optionally build both components into a single library if they so wish.<br />
</p>
<p>The registration library consists of methods that specify all user-defined operations and the hardware cores they are designed for. It also consists of methods that allow operations to be validated for sanity at the time of network creation. The registration library is loaded and executed on the ARM CPU.</p>
<p>The hardware-specific implementation libraries expose several other methods that implement operation instance creation, execution, profiling and destruction. These are implemented with programming constructs supported from corresponding software platforms, such as OpenCL for GPU and Hexagon-NN SDK for DSP. While core-specific implementation files may differ entirely in source they are all required to interface with SNPE using a set of C APIs defined in $SDK_ROOT/share/SnpeUdo/include/SnpeUdo. The complete details on these APIs can be obtained from <a href="group__c__plus__plus__apis.html">C++ API</a>.</p>
<h1><a class="anchor" id="udo_workflow"></a>
UDO workflow</h1>
<p>SNPE recommends the following workflow in developing and integrating a UDO into the runtime:</p>
<p><a class="anchor" id="fig_udo_workflow"></a><p> <div style= text-align:left;><img src="images/UdoWorkflow.png" alt="UDO" width="50%" height="50%"><br/><br/><b></b></div><br/> </p>
<p>The first step in the workflow is to identify the operations in the model that need to be expressed as User-defined operations and describing their attributes through a configuration file. The format and contents of this file are described in <a class="el" href="udo_operator_definition.html">Defining a UDO</a>.</p>
<p>The next set of steps produce the components of a UDO package by creating source files for the UDO kernels and compiling them against appropriate tool-chains to generate dynamic libraries specific to hardware cores such as the GPU and DSP. SNPE provides a tool called snpe-udo-package-generator that assists users in creating common skeleton code for interfacing with SNPE UDO APIs and leaves placeholders for users to fill in the kernel implementation. It also generates makefiles for common targets such as X86 and Android and for runtimes per target specified in the config file.<br />
 For more details on the package generation refer to <a class="el" href="creating_udo_package.html">Creating a UDO Package</a>. For details on compiling the UDO package for a specific runtime refer to <a class="el" href="compiling_udo_package.html">Compiling a UDO package</a>.</p>
<p>The config file created in the first step is also required to be used by the SNPE model conversion tools along with the actual trained model to allow interpretation of the user-defined operations using definitions from the file. The resulting DLC files can then be inspected using tools like snpe-dlc-info to probe the attributes of the UDOs in the model, which is not possible with opaque representations such as with UDLs. For details on creating (and optionally quantizing) DLCs with UDOs refer to <a class="el" href="preparing_model_with_udo.html">Preparing a model with UDO</a>. Optionally, models with UDOs can also be quantized using SNPE quantization tools to be used with fixed-point runtimes such as DSP. The quantizer tool estimates quantization ranges for activations from all layers in the network including UDOs. Since the tool runs offline on an x86 host machine it is required to have a CPU implementation for the UDO in order to perform inference through the entire network. This is also illustrated in dotted lines in the workflow diagram. Refer to <a class="el" href="preparing_model_with_udo.html#quantize_network_with_udo">Quantizing a DLC with UDO</a> for details on the quantization process.</p>
<p>The final step in this workflow is to be able to actually execute network models with UDOs. SNPE applications use the UDO package to register UDO implementations within the process that runs inference on select network models. It should be noted that these UDOs can be exercised by multiple instances of SNPE simultaneously without race conditions, which increases the overall throughput for network inference. For more details on the UDO package registration process refer to <a class="el" href="running_model_with_udo.html">Running a model with UDO</a>.</p>
<p>If the DSP implementation library of the UDO is not signed for execution on a signed process domain (the default for a SNPE applicaiton), it is required to request the use of an unsigned process domain. Unsigned process domains apply only to the DSP target, and allow SNPE to use unsigned UDO implementation libraries. To see how to utilize an unsigned process domain with the SNPE application, refer to <a class="el" href="running_model_with_udo.html">Running a model with UDO</a>. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!--%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  Copyright (c) 2016-2018 Qualcomm Technologies, Inc.
  All Rights Reserved.
  Confidential and Proprietary - Qualcomm Technologies, Inc.
 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 -->
<!-- start footer part -->
<div id="nav-path" class="navpath" font-size:small;><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">
      <p align="right">
        80-NL315-14 A <br>
        MAY CONTAIN U.S. AND INTERNATIONAL EXPORT CONTROLLED INFORMATION
        <!--If the Controlled Distribution statement is to be included, uncomment below:-->
        <!--<b>Controlled Distribution - DO NOT COPY</b>-->
        <img class="footer" width:5%; alt="QTI Logo" src="images/QTI_Logo.png" />
      </p>
    </li>
  </ul>
</div>
</body>
</html>
