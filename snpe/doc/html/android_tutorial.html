<!--%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  Copyright (c) 2016-2018 Qualcomm Technologies, Inc.
  All Rights Reserved.
  Confidential and Proprietary - Qualcomm Technologies, Inc.
 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
-->
<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"></meta>
<meta http-equiv="X-UA-Compatible" content="IE=9"></meta>
<title>Snapdragon Neural Processing Engine SDK: Android Tutorial</title>
<link href="tabs.css" rel="stylesheet" type="text/css"></link>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="autoEnterCurrentDate.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="is.css" rel="stylesheet" type="text/css" ></link>
<link href="custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Snapdragon Neural Processing Engine SDK
   <span id="projectnumber"></span></div>
   <div id="projectbrief">Reference Guide</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('android_tutorial.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Android Tutorial </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="tutorial_android_prerequisites"></a>
Prerequisites</h1>
<ul>
<li>
The SNPE SDK has been set up following the <a class="el" href="setup.html">SNPE Setup</a> chapter. </li>
<li>
The <a class="el" href="tutorial_setup.html">Tutorials Setup</a> has been completed. </li>
</ul>
<h1><a class="anchor" id="tutorial_android_introduction"></a>
Introduction</h1>
<p>This tutorial walks through the process of integrating the SNPE and <a class="el" href="tools.html#tools_snpe-platform-validator">snpe-platform-validator</a> Java APIs within an Android application.</p>
<p>The SNPE and Platform Validator Java APIs are made available as an Android Archive (AAR) file which application developers include as a dependency of their applications.</p>
<h1><a class="anchor" id="including_sdk_as_gradle_project_dependency"></a>
Gradle project dependency</h1>
<div class="fragment"><div class="line">allprojects {</div><div class="line">    repositories {</div><div class="line">        ...</div><div class="line">        flatDir {</div><div class="line">            // Marks the directory as a repository for</div><div class="line">            // dependencies. Place the snpe-release.aar</div><div class="line">            // in the directory below.</div><div class="line">            dirs &#39;libs&#39;</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line">...</div><div class="line">dependencies {</div><div class="line">    ...</div><div class="line">    // This adds the SNPE SDK as a project dependency</div><div class="line">    compile(name: &#39;snpe-release&#39;, ext:&#39;aar&#39;)</div><div class="line">    // This adds the Platform Validator tool (optional) as a project dependency</div><div class="line">    compile(name: &#39;platformvalidator-release&#39;, ext:&#39;aar&#39;)</div><div class="line">}</div></div><!-- fragment --><p>In case both the archives are required in a project, "pickFirst" need to be used in gradle to avoid library conflicts.</p>
<div class="fragment"><div class="line">android {</div><div class="line">    ...</div><div class="line">    packagingOptions {</div><div class="line">        pickFirst &#39;lib/arm64-v8a/libc++_shared.so&#39;</div><div class="line">        pickFirst &#39;lib/armeabi-v7a/libSNPE.so&#39;</div><div class="line">        pickFirst &#39;lib/arm64-v8a/libsnpe_dsp_domains_v2.so&#39;</div><div class="line">        pickFirst &#39;lib/arm64-v8a/libsnpe_dsp_v65_domains_v2_skel.so&#39;</div><div class="line">        pickFirst &#39;lib/armeabi-v7a/libsnpe_dsp_v65_domains_v2_skel.so&#39;</div><div class="line">        pickFirst &#39;lib/arm64-v8a/libsnpe_dsp_v66_domains_v2_skel.so&#39;</div><div class="line">        pickFirst &#39;lib/armeabi-v7a/libsnpe_dsp_v66_domains_v2_skel.so&#39;</div><div class="line">        pickFirst &#39;lib/armeabi-v7a/libc++_shared.so&#39;</div><div class="line">        pickFirst &#39;lib/armeabi-v7a/libsnpe_dsp_domains_v2.so&#39;</div><div class="line">        pickFirst &#39;lib/arm64-v8a/libSNPE.so&#39;</div><div class="line">        pickFirst &#39;lib/armeabi-v7a/libsymphony-cpu.so&#39;</div><div class="line">        pickFirst &#39;lib/arm64-v8a/libsymphony-cpu.so&#39;</div><div class="line">    }</div></div><!-- fragment --><h1><a class="anchor" id="platformvalidator_api_overview"></a>
Platform Validator Java API Overview</h1>
<p>Once the optional dependency of platformform validator is added, the Platform Validator classes under the <b>com.qualcomm.qti.platformvalidator</b> package will be available in the application classpath.</p>
<p>All applications will first create an object of Platform Validator with required runtime and then use that object to call validation APIs as described below.</p>
<h2><a class="anchor" id="platform_validator_usage"></a>
Using Platform Validator</h2>
<div class="fragment"><div class="line"><span class="comment">//Platform validator class for object creation</span></div><div class="line"><span class="keyword">import</span> <a class="code" href="namespacecom.html">com</a>.<a class="code" href="namespacecom_1_1qualcomm.html">qualcomm</a>.<a class="code" href="namespacecom_1_1qualcomm_1_1qti.html">qti</a>.<a class="code" href="namespacecom_1_1qualcomm_1_1qti_1_1platformvalidator.html">platformvalidator</a>.<a class="code" href="group__java__apis.html#classcom_1_1qualcomm_1_1qti_1_1platformvalidator_1_1PlatformValidator">PlatformValidator</a>;</div><div class="line"></div><div class="line"><span class="comment">//available runtimes are defined in this class</span></div><div class="line"><span class="keyword">import</span> <a class="code" href="namespacecom.html">com</a>.<a class="code" href="namespacecom_1_1qualcomm.html">qualcomm</a>.<a class="code" href="namespacecom_1_1qualcomm_1_1qti.html">qti</a>.<a class="code" href="namespacecom_1_1qualcomm_1_1qti_1_1platformvalidator.html">platformvalidator</a>.<a class="code" href="interfacecom_1_1qualcomm_1_1qti_1_1platformvalidator_1_1PlatformValidatorUtil.html">PlatformValidatorUtil</a>;</div><div class="line">...</div><div class="line"><span class="comment">//This create platform validator object for GPU runtime class</span></div><div class="line">PlatformValidator pv = <span class="keyword">new</span> PlatformValidator(PlatformValidatorUtil.Runtime.GPU);</div><div class="line"></div><div class="line"><span class="comment">// To check in general runtime is working use isRuntimeAvailable</span></div><div class="line"><span class="keywordtype">boolean</span> check = pv.isRuntimeAvailable(getApplication());</div><div class="line"></div><div class="line"><span class="comment">// To check SNPE runtime is working use runtimeCheck</span></div><div class="line"><span class="keywordtype">boolean</span> check = pv.runtimeCheck(getApplication());</div><div class="line"></div><div class="line"><span class="comment">//To get core version use libVersion api</span></div><div class="line">String str = pv.coreVersion(getApplication());</div><div class="line"></div><div class="line"><span class="comment">//To get core version use coreVersion api</span></div><div class="line">String str = pv.coreVersion(getApplication());</div><div class="line"></div><div class="line"><span class="comment">//List of available runtimes</span></div><div class="line">PlatformValidatorUtil.Runtime.CPU</div><div class="line">PlatformValidatorUtil.Runtime.GPU</div><div class="line">PlatformValidatorUtil.Runtime.DSP</div><div class="line">PlatformValidatorUtil.Runtime.GPU_FLOAT16</div><div class="line">PlatformValidatorUtil.Runtime.AIP</div></div><!-- fragment --><h1><a class="anchor" id="snpe_api_overview"></a>
SNPE Java API Overview</h1>
<p>Once the dependency is added, the SNPE classes under the <b>com.qualcomm.qti.snpe</b> package will be available in the application classpath.</p>
<p>Most applications will follow the following pattern while using a neural network:</p>
<ol>
<li>
Select the neural network model and runtime target </li>
<li>
Create one or more input tensor(s) </li>
<li>
Populate one or more input tensor(s) with the network input(s) </li>
<li>
Forward propagate the input tensor(s) through the network </li>
<li>
Process the network output tensor(s) </li>
</ol>
<p>The sections below describe how to implement each step described above.</p>
<h2><a class="anchor" id="android_tutorial_config"></a>
Configuring a Neural Network</h2>
<p>The code excerpt below illustrates how to configure and build a neural network using the JAVA APIs.</p>
<div class="fragment"><div class="line"><span class="keyword">final</span> SNPE.NeuralNetworkBuilder builder = <span class="keyword">new</span> SNPE.NeuralNetworkBuilder(application)</div><div class="line">    <span class="comment">// Allows selecting a runtime order for the network.</span></div><div class="line">    <span class="comment">// In the example below use DSP and fall back, in order, to GPU then CPU</span></div><div class="line">    <span class="comment">// depending on whether any of the runtimes is available.</span></div><div class="line">    .setRuntimeOrder(DSP, GPU, CPU)</div><div class="line">    <span class="comment">// Loads a model from DLC file</span></div><div class="line">    .setModel(<span class="keyword">new</span> File(<span class="stringliteral">&quot;&lt;model-path&gt;&quot;</span>));</div><div class="line"><span class="keyword">final</span> NeuralNetwork network = builder.build();</div><div class="line">...</div><div class="line"><span class="comment">// Calling release() once the application no longer needs the network instance</span></div><div class="line"><span class="comment">// is highly recommended as it releases native resources. Alternatively the</span></div><div class="line"><span class="comment">// resources will be released when the instance is garbage collected.</span></div><div class="line">network.release();</div></div><!-- fragment --><p><b>Multiple ways to load a model</b></p>
<p>The SDK currently supports loading a model from a <b>java.io.File</b> within the Android device or from an <b>java.io.FileInputStream</b>.</p>
<h2><a class="anchor" id="creating_an_input_tensor"></a>
Creating an Input Tensor</h2>
<p>The code excerpt below illustrates how to create an input tensor and fill it with the input data.</p>
<div class="fragment"><div class="line"><span class="keyword">final</span> FloatTensor tensor = network.createFloatTensor(height, width, depth);</div><div class="line"></div><div class="line"><span class="keywordtype">float</span>[] input = <span class="comment">// input data from application...</span></div><div class="line"><span class="comment">// Fills the tensor fully</span></div><div class="line">tensor.write(input, 0, input.length);</div><div class="line"><span class="comment">// Fills the tensor at a specific position</span></div><div class="line">tensor.write(input[0], y, x, z);</div><div class="line"></div><div class="line"><span class="comment">// Fills the input tensors map which will be passed to execute()</span></div><div class="line"><span class="keyword">final</span> Map&lt;String, FloatTensor&gt; inputsMap;</div><div class="line">inputsMap.put(<span class="comment">/*network input name*/</span>, tensor);</div></div><!-- fragment --><p><b>Notes about tensors</b></p>
<ul>
<li><b>Reuse of input tensors</b><br />
 Developers are encouraged to re-use the same input tensor instance across multiple calls to NeuralNetwork.execute(..). Tensors are memory bound types and the effect of creating new instances for every execute call may have an impact in the application responsiveness.</li>
<li><b>Batch write to tensor</b><br />
 Tensors are backed by native memory and writing multiple values at once, if possible, will reduce the overhead of crossing the Java and Native boundaries.</li>
</ul>
<h2><a class="anchor" id="propagate_input_tensors_through_network"></a>
Propagate Input Tensors Through the Network</h2>
<p>The excerpt of code below shows how to propagate input tensors through the neural network.</p>
<div class="fragment"><div class="line"><span class="keyword">final</span> Map&lt;String, FloatTensor&gt; outputsMap = network.execute(inputsMap);</div><div class="line"><span class="keywordflow">for</span> (Map.Entry&lt;String, FloatTensor&gt; output : outputsMap.entrySet()) {</div><div class="line">    <span class="comment">// An output tensor for each output layer will be returned.</span></div><div class="line">}</div></div><!-- fragment --><h2><a class="anchor" id="process_the_neural_network_output"></a>
Process the Neural Network Output</h2>
<p>The excerpt of code below shows how to read the output tensor of an output layer.</p>
<div class="fragment"><div class="line"><span class="keyword">final</span> Map&lt;String, FloatTensor&gt; outputsMap = network.execute(inputsMap);</div><div class="line"><span class="keywordflow">for</span> (Map.Entry&lt;String, FloatTensor&gt; output : outputsMap.entrySet()) {</div><div class="line">    <span class="keyword">final</span> FloatTensor tensor = output.getValue();</div><div class="line">    <span class="keyword">final</span> <span class="keywordtype">float</span>[] values = <span class="keyword">new</span> <span class="keywordtype">float</span>[tensor.getSize()];</div><div class="line">    tensor.read(values, 0, values.length);</div><div class="line">    <span class="comment">// Process the output ...</span></div><div class="line">}</div></div><!-- fragment --><h2><a class="anchor" id="release_input_and_output_tensors"></a>
Release Input and Output Tensors</h2>
<p>Tensors are encouraged to be reused to reduce the application overhead. However, once the application no longer needs the input and/or output tensors, it is highly recommended to call release() on them to release native resources. This is particularly important for multi-threaded applications.</p>
<div class="fragment"><div class="line"><span class="comment">// Release input tensors</span></div><div class="line"><span class="keywordflow">for</span> (FloatTensor tensor: inputsMap) {</div><div class="line">    tensor.release();</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// Release output tensors</span></div><div class="line"><span class="keywordflow">for</span> (FloatTensor tensor: outputsMap) {</div><div class="line">    tensor.release();</div><div class="line">}</div></div><!-- fragment --><h1><a class="anchor" id="android_sample_applications"></a>
Android Sample Application</h1>
<p>The SNPE Android SDK includes a sample application that showcases the SDK features. The application source code is in:</p><ul>
<li>$SNPE_ROOT/examples/android/image-classifiers</li>
</ul>
<p>Here is a screenshot of the sample:</p>
<p><a class="anchor" id="fig_snpe_root_sample_images"></a>  <div style= text-align:left;><img src="images/snpe_root_sample_images.png" alt="SNPE" width="25%" height="25%"><br/><br/><b></b></div><br/> </p>
<p>Note that SNPE provides the following AAR file which include necessary binaries: </p><ul>
<li>
<b>snpe-release.aar</b>: Native binaries compiled with clang using libc++ STL  </li>
</ul>
<p>Please set environment variable SNPE_AAR to this AAR file.</p>
<p>To build this sample, include the SNPE SDK AAR as described above and build with the following commands.</p>
<div class="fragment"><div class="line">export SNPE_AAR=snpe-release.aar</div><div class="line">cd $SNPE_ROOT/examples/android/image-classifiers</div><div class="line">bash ./setup_alexnet.sh</div><div class="line">bash ./setup_inceptionv3.sh</div><div class="line">cp ../../../android/$SNPE_AAR app/libs/snpe-release.aar</div><div class="line">./gradlew assembleDebug</div></div><!-- fragment --><p><b>Note:</b> </p><ul>
<li>
To build the sample, import the network model and sample images by invoking the <b>setup_models.sh</b> script as described above. </li>
<li>
If building produces the error <b>gradle build failure due to "SDK location not found"</b>, set the environment variable ANDROID_HOME to point to your sdk location. </li>
<li>
Building the sample code with gradle requires java 8. </li>
</ul>
<p>After the build successfully completes, the output APK can be found in the application build folder:</p><ul>
<li>$SNPE_ROOT/examples/android/image-classifiers/app/build/outputs/apk </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!--%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  Copyright (c) 2016-2018 Qualcomm Technologies, Inc.
  All Rights Reserved.
  Confidential and Proprietary - Qualcomm Technologies, Inc.
 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 -->
<!-- start footer part -->
<div id="nav-path" class="navpath" font-size:small;><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">
      <p align="right">
        80-NL315-14 A <br>
        MAY CONTAIN U.S. AND INTERNATIONAL EXPORT CONTROLLED INFORMATION
        <!--If the Controlled Distribution statement is to be included, uncomment below:-->
        <!--<b>Controlled Distribution - DO NOT COPY</b>-->
        <img class="footer" width:5%; alt="QTI Logo" src="images/QTI_Logo.png" />
      </p>
    </li>
  </ul>
</div>
</body>
</html>
